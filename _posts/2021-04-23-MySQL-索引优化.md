---
layout: post
title: MySQL-ç´¢å¼•ä¼˜åŒ–
categories: MySQL
description: 
keywords: MySQL, index, ç´¢å¼•ä¼˜åŒ–
---

æœ¬æ–‡è¿ç”¨ **Explain** ç»“åˆå…·ä½“çš„ **SQL** è¯­å¥ï¼Œåˆ†æç´¢å¼•å¤±æ•ˆçš„å¤šç§æƒ…å†µä»¥åŠå¦‚ä½•å¯¹ç´¢å¼•è¿›è¡Œä¼˜åŒ–ã€‚æ‰€æœ‰çš„ä¼˜åŒ–åŸç†ï¼Œéƒ½å¯ä»¥é€šè¿‡ç´¢å¼•çš„æ•°æ®ç»“æ„æ¨å¯¼ã€éªŒè¯ã€‚



## æœ¬æ–‡ç”¨åˆ°çš„ç¤ºä¾‹è¡¨

â€‹	åˆ›å»ºä¸¤ä¸ª**è¡¨ç»“æ„å®Œå…¨ä¸€æ ·**çš„è¡¨ï¼Œ**employees_small** è¡¨çš„æ•°æ®é‡å°ï¼Œ**employees_large** è¡¨çš„æ•°æ®é‡å¤§ã€‚

### employees_small è¡¨

```sql
-- å»ºè¡¨
CREATE TABLE `employees_small` (
`id` INT(11) NOT NULL AUTO_INCREMENT,
`name` VARCHAR(24) NOT NULL DEFAULT '' COMMENT 'å§“å',
`age` INT(11) NOT NULL DEFAULT '0' COMMENT 'å¹´é¾„',
`position` VARCHAR(20) NOT NULL DEFAULT '' COMMENT 'èŒä½',
`hire_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å…¥èŒæ—¶é—´',
PRIMARY KEY (`id`),
KEY `idx_name_age_position` (`name`,`age`,`position`)
) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='å‘˜å·¥è®°å½•è¡¨';

-- ç›´æ¥æ’å…¥å°‘é‡æ•°æ®
INSERT INTO employees_small(NAME,age,POSITION,hire_time) VALUES('LiLei',22,'manager',NOW());
INSERT INTO employees_small(NAME,age,POSITION,hire_time) VALUES('HanMeimei', 23,'dev',NOW());
INSERT INTO employees_small(NAME,age,POSITION,hire_time) VALUES('Lucy',23,'dev',NOW());
```



### employees_large è¡¨

```sql
-- å»ºè¡¨
CREATE TABLE `employees_large` (
`id` INT(11) NOT NULL AUTO_INCREMENT,
`name` VARCHAR(24) NOT NULL DEFAULT '' COMMENT 'å§“å',
`age` INT(11) NOT NULL DEFAULT '0' COMMENT 'å¹´é¾„',
`position` VARCHAR(20) NOT NULL DEFAULT '' COMMENT 'èŒä½',
`hire_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å…¥èŒæ—¶é—´',
PRIMARY KEY (`id`),
KEY `idx_name_age_position` (`name`,`age`,`position`)
) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='å‘˜å·¥è®°å½•è¡¨';

-- é€šè¿‡å­˜å‚¨è¿‡ç¨‹ï¼Œæ’å…¥å¤§é‡æ•°æ®
-- åˆ›å»ºå­˜å‚¨è¿‡ç¨‹
DROP PROCEDURE IF EXISTS insert_emp;
DELIMITER ;;
CREATE PROCEDURE insert_emp()
BEGIN
DECLARE i INT;
SET i=1;
WHILE(i<=100000)DO
INSERT INTO employees_large(NAME,age,POSITION) VALUES(CONCAT('people',i),i,'dev');
SET i=i+1;
END WHILE;
END;;
DELIMITER ;
-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œæ’å…¥æ•°æ®
CALL insert_emp();
```



## ç´¢å¼•ä¼˜é›…çš„ä½¿ç”¨æ–¹å¼:dancer:

â€‹	åœ¨è¿™ä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å…ˆåªä½¿ç”¨æ•°æ®é‡è¾ƒå°çš„ **emplyees_small** è¡¨æ¥åšç®€å•æ¼”ç¤ºï¼Œæ•°æ®é‡è¾ƒå¤§çš„è¡¨å°†åœ¨ä¸‹ä¸€å°ç»“ä¸­ä½¿ç”¨ã€‚

`Tips`: ç”±äºMySQLå†…éƒ¨ä¼˜åŒ–å™¨ä¼šæ ¹æ®è¡¨å¤§å°ç­‰å¤šé¡¹å› ç´ è¿›è¡Œæ•´ä½“è¯„ä¼°ï¼Œè®¡ç®— `cost` æ¥åšå†³ç­–ï¼Œè¯¦æƒ…è§ [â€œæœ‰ç—…çš„SQLâ€](#æœ‰ç—…çš„SQL)ã€‚

### ä¸€ã€å…¨å€¼åŒ¹é…

```sql
EXPLAIN SELECT * FROM employees_small WHERE NAME= 'LiLei';
EXPLAIN SELECT * FROM employees_small WHERE NAME= 'LiLei' AND age = 22;
EXPLAIN SELECT * FROM employees_small WHERE NAME= 'LiLei' AND age = 22 AND POSITION ='manager';
```



### äºŒã€æœ€å·¦å‰ç¼€æ³•åˆ™

â€‹	ä»¥ä¸‹**SQL**è¯­å¥ä¸­ï¼Œåªæœ‰ **A** ä¼šèµ°ç´¢å¼• å› ä¸ºç´¢å¼• `idx_name_age_position` æ˜¯è¿™ä¹ˆå®šä¹‰çš„ â€”â€” (`name`, `age`, `position`)

```sql
-- A
EXPLAIN SELECT * FROM employees_small WHERE NAME = 'LiLei' AND age = 31;
-- B
EXPLAIN SELECT * FROM employees_small WHERE age = 30 AND POSITION = 'dev';
-- C
EXPLAIN SELECT * FROM employees_small WHERE POSITION = 'manager';
```

> **ç‰¹ä¾‹**

```sql
EXPLAIN SELECT * FROM employees_small WHERE age = 22 AND NAME= 'LiLei' AND POSITION ='manager';
```

â€‹	è¿™æ¡ **SQL** è¯­å¥æ˜¾ç„¶ä¸ç¬¦åˆ**æœ€å·¦å‰ç¼€æ³•åˆ™**ï¼Œä½†æ˜¯ä»ç„¶èƒ½èµ°ç´¢å¼•ã€‚æ˜¯å› ä¸ºMySQLçš„ä¼˜åŒ–å™¨å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œè™½ç„¶MySQLçš„ä¼˜åŒ–å™¨å…·å¤‡è¿™æ ·çš„åŠŸèƒ½ï¼Œä¹Ÿåº”å½“åœ¨ç¼–å†™**SQL**è¯­å¥çš„æ—¶å€™éµå®ˆè¿™ä¸€æ³•åˆ™ï¼Œå‡è½»MySQLçš„è´Ÿæ‹…ã€‚



### ä¸‰ã€ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œ(è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢)

â€‹	ğŸ‘‡ä»¥ä¸‹**SQL**è¯­å¥ä¼šå› æ­¤è€Œå¤±æ•ˆï¼Œèµ°å…¨è¡¨æ‰«æ

```sql
-- åœ¨nameä¸Šä½¿ç”¨å‡½æ•°
EXPLAIN SELECT * FROM employees_small WHERE LEFT(NAME, 2) = 'Li' AND age = 22 AND POSITION ='manager';
-- åœ¨nameä¸Šè¿›è¡Œ(è‡ªåŠ¨)ç±»å‹è½¬æ¢
EXPLAIN SELECT * FROM employees_small WHERE NAME = 1000;
```

### å››ã€å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—

â€‹	ä¸‹åˆ—**SQL**ä¸­ï¼Œ**A**èƒ½å¤Ÿå‘½ä¸­ç´¢å¼•çš„ç´¢å¼•å­—æ®µï¼Œ**B**åªèƒ½åå­— `name` å’Œ `age` å­—æ®µ

```sql
-- A
EXPLAIN SELECT * FROM employees_small WHERE NAME= 'LiLei' AND age = 22 AND POSITION ='manager';
-- B
EXPLAIN SELECT * FROM employees_small WHERE NAME= 'LiLei' AND age > 22 AND POSITION ='manager';
```



### äº”ã€å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå‡å°‘*

â€‹	**A**èµ°äº†è¦†ç›–ç´¢å¼•ï¼Œ**Extra**ä¸­æ˜¾ç¤ºä¸º Using index ï¼›**B**ä¸­ **Extra** æ˜¾ç¤ºä¸º NULLã€‚(è¦†ç›–ç´¢å¼•ä»¥åï¼Œå¯ä»¥ä¸éœ€è¦**å›è¡¨**æ“ä½œï¼ŒèŠ‚çœäº†æ—¶é—´)

```sql
-- A
EXPLAIN SELECT NAME, age FROM employees_small WHERE NAME= 'LiLei' AND age = 23 AND POSITION = 'manager';
-- B
EXPLAIN SELECT * FROM employees_small WHERE NAME= 'LiLei' AND age = 23 AND POSITION = 'manager';
```

![](/images/posts/MySQL/cover index.png)



### å…­ã€!=ã€<>ã€is nullã€is not null å¯èƒ½ä¼šä½¿ç´¢å¼•å¤±æ•ˆ

â€‹	ä»¥ä¸‹**SQL**éƒ½ä¸ä¼šèµ°ç´¢å¼•ï¼š

```sql
EXPLAIN SELECT * FROM employees_small WHERE NAME != 'LiLei';
EXPLAIN SELECT * FROM employees_small WHERE NAME IN ('LiLei', 'HanMeimei');
EXPLAIN SELECT * FROM employees_small WHERE NAME IS NULL;
EXPLAIN SELECT * FROM employees_small WHERE NAME IS NOT NULL;
```



### ä¸ƒã€å°½é‡é¿å…likeä»¥%å¼€å¤´

â€‹	**A**æ²¡æœ‰èµ°ç´¢å¼•ï¼Œ**B**èµ°äº†ç´¢å¼•

```sql
-- A
EXPLAIN SELECT * FROM employees_small WHERE NAME LIKE '%Lei';
-- B
EXPLAIN SELECT * FROM employees_small WHERE NAME LIKE 'Lei%';
```

> **ä¼˜åŒ–æ–¹æ³•**

â€‹	ä½¿ç”¨è¦†ç›–ç´¢å¼•ä»£æ›¿*å·ï¼Œå¯ä»¥è®©**A**èµ°ç´¢å¼•ã€‚(ä»¥ä¸‹SQLèƒ½ä½¿**A**èµ°è¦†ç›–ç´¢å¼•)

```sql
EXPLAIN SELECT name FROM employees_small WHERE NAME LIKE '%Lei';
		.
		.
		.
EXPLAIN SELECT name,age,POSITION FROM employees_small WHERE NAME LIKE '%Lei';
```



### å…«ã€å°½é‡å°‘ç”¨orï¼Œorå¯èƒ½ä¼šä½¿ç´¢å¼•å¤±æ•ˆ

â€‹	ä»¥ä¸‹**SQL**ä½¿ç”¨äº†**or**ï¼Œç´¢å¼•å¤±æ•ˆ

```sql
EXPLAIN SELECT * FROM employees_small WHERE NAME = 'LiLei' OR NAME = 'HanMeimei';
```



### å°ç»“

â€‹	å¼•ç”¨<font color="red">å°šç¡…è°·é˜³å“¥çš„å…¬å¼€èµ„æ–™</font>è¿›è¡Œæ€»ç»“ï¼š

![](/images/posts/MySQL/index_summary.png)



**ã€ä¼˜åŒ–æ€»ç»“å£è¯€ã€‘**

|                |                |
| :------------: | :------------: |
| å…¨å€¼åŒ¹é…æˆ‘æœ€çˆ± | æœ€å·¦å‰ç¼€è¦éµå®ˆ |
| å¸¦å¤´å¤§å“¥ä¸èƒ½æ­» | ä¸­é—´å…„å¼Ÿä¸èƒ½æ–­ |
| ç´¢å¼•åˆ—ä¸Šå°‘è®¡ç®— | èŒƒå›´ä¹‹åå…¨å¤±æ•ˆ |
| Likeç™¾åˆ†å†™æœ€å³ | è¦†ç›–ç´¢å¼•ä¸å†™*  |
| ä¸ç­‰ç©ºå€¼è¿˜æœ‰or | ç´¢å¼•å¤±æ•ˆè¦å°‘ç”¨ |



## "æœ‰ç—…"çš„SQL:dizzy:

â€‹	æœ¬å°ç»“å°†ä»‹ç»å‡ ä¸ªâ€œå¥‡æ€ªâ€çš„SQLï¼š

`Tips`ï¼š æœ¬æ–‡ä»…å¯¹SQLâ€œå¥‡æ€ªâ€ç°è±¡çš„å‡ºç°ç»™å‡ºåˆç†çš„æ¨æµ‹ä»¥åŠå¦‚ä½•æŸ¥çœ‹MySQLè®¡ç®—å‡ºçš„`cost`å€¼(ç”¨äºç´¢å¼•é€‰æ‹©)ï¼Œä¸æä¾›è®¡ç®—å…¬å¼ã€‚

### å¥‡æ€ªçš„SQLä¸€

- å…ˆç»™è¡¨ **employees_small** ä¸´æ—¶åŠ ä¸Šç´¢å¼•

  ```sql
  ALTER TABLE `employees_small` ADD INDEX `idx_age` (`age`);
  ```

- æ‰§è¡Œä»¥ä¸‹**SQL**è¯­å¥

  ```sql
  EXPLAIN SELECT * FROM employees_small WHERE age >=1 AND age <=2000;
  EXPLAIN SELECT * FROM employees_small WHERE age >=1 AND age <=1000;
  EXPLAIN SELECT * FROM employees_small WHERE age >=1001 AND age <=2000;
  ```

  ç»“æœä¸ºï¼š

  ![](/images/posts/MySQL/wired_SQL.png)

- æŠŠè¡¨è¿˜åŸ

  ```sql
  ALTER TABLE `employees_small` DROP INDEX `idx_age`;
  ```

###  å¥‡æ€ªçš„SQLäºŒ

- å¯¹è¡¨ **employees_small** å’Œè¡¨ **employees_large** æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢

  ```sql
  -- A
  EXPLAIN SELECT * FROM employees_small WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  -- B
  EXPLAIN SELECT * FROM employees_large WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  ```

  ![](/images/posts/MySQL/range_query.png)

- æŒ‰ç…§å‰é¢æ‰€å­¦æ¥åˆ†æï¼Œè¿™é‡Œåº”å½“æ˜¯å‘½ä¸­äº†ç´¢å¼•çš„`name`å­—æ®µï¼Œä½†æ˜¯åœ¨å¤§è¡¨ä¸­æ²¡èµ°ç´¢å¼•

  - å¯¹äºè¿™ä¸€ç°è±¡ï¼Œå¯èƒ½æ˜¯å› ä¸ºMySQLè§‰å¾—ç¬¬ä¸€ä¸ªå­—æ®µå°±ç”¨èŒƒå›´ï¼Œç»“æœé›†åº”è¯¥å¾ˆå¤§ï¼Œå›è¡¨æ•ˆç‡ä¸é«˜ï¼Œè¿˜ä¸å¦‚å°±å…¨è¡¨æ‰«æã€‚

- å’Œå¼ºåˆ¶èµ°ç´¢å¼•å¯¹æ¯”

  ```sql
  -- ä½¿ç”¨Explainè¿›è¡Œåˆ†æ
  -- MySQLçš„é€‰æ‹©
  EXPLAIN SELECT * FROM employees_large WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  -- å¼ºåˆ¶èµ°ç´¢å¼•
  EXPLAIN SELECT * FROM employees_large FORCE INDEX(idx_name_age_position) WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  ```

  ![](/images/posts/MySQL/FORCE INDEX.png)

  ```sql
  -- å®é™…è¿è¡Œä¸€ä¸‹
  -- 0.027s
  SELECT SQL_NO_CACHE * FROM employees_large WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  -- 0.033s
  SELECT SQL_NO_CACHE * FROM employees_large FORCE INDEX(idx_name_age_position) WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  ```

- ç»“æœ

  - å¯¹äºä½¿ç”¨**Explain**åˆ†æåï¼Œæ˜æ˜å¼ºåˆ¶èµ°ç´¢å¼•çš„**rows**è¦å°å¾ˆå¤šï¼Œä½†MySQLå®é™…ä¸Šå´æ²¡èµ°ç´¢å¼•ï¼Œå¹¶ä¸”æŸ¥è¯¢æ—¶é—´æ¯”å¼ºåˆ¶èµ°äº†ç´¢å¼•æ‰€ç”¨çš„æ—¶é—´ç•¥çŸ­ã€‚

- ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–

  ```sql
  EXPLAIN SELECT name, age, position FROM employees_large WHERE NAME > 'LiLei' AND age = 22 AND POSITION ='manager';
  ```

  ![](/images/posts/MySQL/wired_SQL_äºŒ.png)

### å¥‡æ€ªçš„SQLä¸‰

- å¯¹è¡¨ **employees_small** å’Œè¡¨ **employees_large** æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢

  ```sql
  EXPLAIN SELECT * FROM employees_small WHERE NAME LIKE 'L%' AND age = 22 AND POSITION ='manager';
  EXPLAIN SELECT * FROM employees_large WHERE NAME LIKE 'L%' AND age = 22 AND POSITION ='manager';
  ```

  ![](/images/posts/MySQL/wired_SQL_ä¸‰_compare.png)

- æŒ‰ç…§B+æ ‘çš„ç»“æ„ï¼Œä½¿ç”¨ **like "k%"**è¿‡æ»¤å®Œ`name`å­—æ®µä»¥åï¼Œå¾—åˆ°çš„ç»“æœä¸­ `age`ã€`position`æ˜¯æ— åºçš„ï¼ŒæŒ‰ç†æ¥è¯´ä¸èƒ½å‘½ä¸­è¿™ä¸¤ä¸ªå­—æ®µ

  -  **like "k%"**å¯èƒ½ä¼šä½¿ç”¨**ç´¢å¼•ä¸‹æ¨**

- é‚£ä¸ºä»€ä¹ˆåœ¨[å¥‡æ€ªçš„SQLäºŒ](#å¥‡æ€ªçš„SQLäºŒ)ä¸­ï¼Œæ²¡æœ‰å‘½ä¸­æ‰€æœ‰å­—æ®µå‘¢ã€‚

  - å¯èƒ½æ˜¯ç”±äºå’Œ **like "k%"**ä½¿ç”¨ **>** ç­‰ç¬¦å·çš„èŒƒå›´è¿‡å¤§ï¼Œè¿‡æ»¤åçš„ç»“æœé›†ä¾ç„¶å¾ˆå¤§ï¼Œé‚£ä¹ˆå›è¡¨æ“ä½œçš„æ¬¡æ•°è¿˜æ˜¯ä¸å¯é¿å…çš„å¾ˆå¤šï¼Œè¿™æ ·è¿˜ä¸å¦‚ç›´æ¥èµ°ä¸»é”®ç´¢å¼•å…¨è¡¨æ‰«æã€‚

**ã€ç´¢å¼•ä¸‹æ¨ã€‘:** æ˜¯MySQL 5.6å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚

- åœ¨MySQL 5.6ä¹‹å‰ï¼šè¿™ä¸ªæŸ¥è¯¢ä¼šå…ˆåœ¨è”åˆç´¢å¼•ä¸­ï¼Œ**â‘ **æ‰¾å‡ºæ‰€æœ‰æ»¡è¶³ **like "k%"**çš„ç´¢å¼•ï¼Œ**â‘¡**ç„¶åå†æŒ‰å…¶å¯¹åº”çš„ä¸»é”®é€ä¸ªå›è¡¨ï¼Œåœ¨ä¸»é”®ç´¢å¼•ä¸Šæ‰¾å‡ºç›¸åº”çš„è®°å½•åï¼Œ**â‘¢**å†å»åˆ¤æ–­æ˜¯å¦å‰©ä¸‹çš„æ¡ä»¶(è¿™é‡Œæ˜¯æŒ‡**age**å’Œ**position**ä¸¤ä¸ªå­—æ®µ)

- MySQL 5.6ä¹‹åï¼šåœ¨æ‰¾å‡ºæ»¡è¶³ **like "k%"** çš„ç´¢å¼•åï¼Œä¸é©¬ä¸Šå›è¡¨ï¼Œè€Œæ˜¯ç»§ç»­ç”¨å‰©ä½™çš„ç´¢å¼•é¡¹(è¿™é‡ŒæŒ‡**age**å’Œ**position**ä¸¤ä¸ªå­—æ®µ)è¿›è¡Œè¿‡æ»¤ï¼Œç›¸å½“äºâ‘¡å’Œâ‘¢çš„é¡ºåºå¯¹æ¢äº†ä¸€ä¸‹ã€‚**å¥½å¤„æ˜¯**ï¼šç›´æ¥å‡å°‘äº†**å›è¡¨çš„æ¬¡æ•°**

<font color="red">æ³¨æ„</font>ï¼šè¿™é‡ŒæŒ‡çš„æ˜¯äºŒçº§è”åˆç´¢å¼•ï¼Œå¦‚æœæ˜¯ä¸»é”®è”åˆç´¢å¼•ï¼Œæƒ…å†µåˆ™ä¸åŒäº†ï¼è¿™ä¸ªæ—¶å€™ç´¢å¼•ä¸‹æ¨å¹¶ä¸ä¼šèµ·åˆ°å‡å°‘æŸ¥è¯¢å…¨è¡Œæ•°æ®çš„æ•ˆæœã€‚



### å¥‡æ€ªçš„SQLå››

- **in**å’Œ**or**åœ¨è¡¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¼šèµ°ç´¢å¼•ï¼Œåœ¨è¡¨è®°å½•ä¸å¤šçš„æƒ…å†µä¸‹ä¼šé€‰æ‹©å…¨è¡¨æ‰«æ

- åˆ†åˆ«å¯¹ä¸¤å¼ è¡¨åšå¦‚ä¸‹æŸ¥è¯¢

  ```sql
  -- èµ°å…¨è¡¨æŸ¥è¯¢
  EXPLAIN SELECT * FROM employees_small WHERE NAME IN ('LiLei','HanMeimei','Lucy') AND age = 22 AND POSITION='manager';
  -- èµ°ç´¢å¼•
  EXPLAIN SELECT * FROM employees_large WHERE NAME IN ('LiLei','HanMeimei','Lucy') AND age = 22 AND POSITION ='manager';
  
  -- èµ°å…¨è¡¨æŸ¥è¯¢
  EXPLAIN SELECT * FROM employees_small WHERE (NAME = 'LiLei' OR NAME = 'HanMeimei') AND age = 22 AND POSITION='manager';
  -- èµ°ç´¢å¼•
  EXPLAIN SELECT * FROM employees_large WHERE (NAME = 'LiLei' OR NAME = 'HanMeimei') AND age = 22 AND POSITION ='manager';
  ```



â€‹	ä»¥ä¸ŠSQLè¯­å¥è¯æ˜äº†å‰æ–‡æ‰€è¿°çš„ â€œMySQLå†…éƒ¨ä¼˜åŒ–å™¨ä¼šæ ¹æ®å¤šé¡¹å› ç´ è¿›è¡Œè¯„ä¼°â€ã€‚

### ä½¿ç”¨traceå·¥å…·ä¸€æ¢ç©¶ç«Ÿ

â€‹	å…³äº**MySQL**å¦‚ä½•é€‰æ‹©ç´¢å¼•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**trace**å·¥å…·æ¥è§‚å¯Ÿå¼€å¯**trace**å·¥å…·ä¼šå½±å“**mysql**æ€§èƒ½ï¼Œæ‰€ä»¥åªèƒ½ä¸´æ—¶åˆ†æSQLä½¿ç”¨ï¼Œç”¨ å®Œä¹‹åç«‹å³å…³é—­ã€‚

### èƒŒæ™¯

â€‹	å¯¹äºä»¥ä¸‹Aã€Bä¸¤æ¡SQLè¯­å¥ï¼ŒAæ˜¯å…¨è¡¨æ‰«æï¼ŒBä½¿ç”¨äº†è”åˆç´¢å¼•ã€‚ä½¿ç”¨**trace**å·¥å…·æ¥åˆ†æä¸€ä¸‹å®ƒä»¬æ˜¯æ€ä¹ˆèµ°çš„

```sql
-- A: å…¨è¡¨æ‰«æ
EXPLAIN SELECT * FROM employees_large WHERE NAME > 'a';
-- B: èµ°äº†è”åˆç´¢å¼•
EXPLAIN SELECT NAME,age,POSITION FROM employees_large WHERE NAME > 'a';
```



### ä½¿ç”¨æ–¹æ³•

```sql
-- ä¸€ã€å¼€å¯
SET SESSION optimizer_trace="enabled=on",end_markers_in_json=ON; 

-- äºŒã€æ‰§è¡ŒSQLè¯­å¥
...

-- ä¸‰ã€æŸ¥çœ‹trace
SELECT * FROM information_schema.`OPTIMIZER_TRACE`;

-- å››ã€å…³é—­
SET SESSION optimizer_trace="enabled=off";
```

### å¯¹SQLè¯­å¥Aè¿›è¡Œåˆ†æ

```json
{
  "steps": [
    {
        # SQLå‡†å¤‡é˜¶æ®µï¼Œæ ¼å¼åŒ–SQL
      "join_preparation": {
        "select#": 1,
        "steps": [
          {
            "expanded_query": "/* select#1 */ select `employees_large`.`id` AS `id`,`employees_large`.`name` AS `name`,`employees_large`.`age` AS `age`,`employees_large`.`position` AS `position`,`employees_large`.`hire_time` AS `hire_time` from `employees_large` where (`employees_large`.`name` > 'a') order by `employees_large`.`position` limit 0,1000"
          }
        ] /* steps */
      } /* join_preparation */
    },
    {
        # SQLä¼˜åŒ–é˜¶æ®µ
      "join_optimization": {
        "select#": 1,
        "steps": [
          {
            "condition_processing": {
              "condition": "WHERE",
              "original_condition": "(`employees_large`.`name` > 'a')",
              "steps": [
                {
                  "transformation": "equality_propagation",
                  "resulting_condition": "(`employees_large`.`name` > 'a')"
                },
                {
                  "transformation": "constant_propagation",
                  "resulting_condition": "(`employees_large`.`name` > 'a')"
                },
                {
                  "transformation": "trivial_condition_removal",
                  "resulting_condition": "(`employees_large`.`name` > 'a')"
                }
              ] /* steps */
            } /* condition_processing */
          },
          {
            "substitute_generated_columns": {
            } /* substitute_generated_columns */
          },
          {
            "table_dependencies": [
              {
                "table": "`employees_large`",
                "row_may_be_null": false,
                "map_bit": 0,
                "depends_on_map_bits": [
                ] /* depends_on_map_bits */
              }
            ] /* table_dependencies */
          },
          {
            "ref_optimizer_key_uses": [
            ] /* ref_optimizer_key_uses */
          },
          {
              # é¢„ä¼°è¡¨çš„è®¿é—®æˆæœ¬
            "rows_estimation": [
              {
                "table": "`employees_large`",
                "range_analysis": {
                  "table_scan": {  # å…¨è¡¨æ‰«æ
                    "rows": 111392, -- æ‰«æè¡Œæ•°
                    "cost": 22634	-- æŸ¥è¯¢æˆæœ¬
                  } /* table_scan */,
                  "potential_range_indexes": [ # å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•
                    {
                      "index": "PRIMARY",		# ä¸»é”®ç´¢å¼•
                      "usable": false,
                      "cause": "not_applicable"
                    },
                    {
                      "index": "idx_name_age_position",	# è¾…åŠ©ç´¢å¼•
                      "usable": true,
                      "key_parts": [
                        "name",
                        "age",
                        "position",
                        "id"
                      ] /* key_parts */
                    }
                  ] /* potential_range_indexes */,

                  "setup_range_conditions": [
                  ] /* setup_range_conditions */,
                  "group_index_range": {
                    "chosen": false,
                    "cause": "not_group_by_or_distinct"
                  } /* group_index_range */,

                  "analyzing_range_alternatives": {
                    "range_scan_alternatives": [
                      {
                        "index": "idx_name_age_position",
                        "ranges": [
                          "a < name"
                        ] /* ranges */,
                        "index_dives_for_eq_ranges": true,
                        "rowid_ordered": false,
                        "using_mrr": false,
                        "index_only": false,	# æ˜¯å¦æ˜¯è¦†ç›–ç´¢å¼•
                        "rows": 55696,			# æ‰«æè¡Œæ•°
                        "cost": 66836,			# æ‰«ææˆæœ¬
                        "chosen": false,		# æ˜¯å¦é€‰æ‹©
                        "cause": "cost"
                      }
                    ] /* range_scan_alternatives */,
                    "analyzing_roworder_intersect": {
                      "usable": false,
                      "cause": "too_few_roworder_scans"
                    } /* analyzing_roworder_intersect */
                  } /* analyzing_range_alternatives */
                } /* range_analysis */
              }
            ] /* rows_estimation */
          },
          {
            "considered_execution_plans": [ # æœ€ç»ˆé€‰æ‹©çš„è®¿é—®è·¯å¾„
              {
                "plan_prefix": [
                ] /* plan_prefix */,
                "table": "`employees_large`",
                "best_access_path": {
                  "considered_access_paths": [
                    {
                      "rows_to_scan": 111392,
                      "access_type": "scan",# è®¿é—®ç±»å‹ï¼šscanä¸ºå…¨è¡¨æ‰«æ
                      "resulting_rows": 55696,
                      "cost": 22631,
                      "chosen": true		# æ˜¯å¦é€‰æ‹©
                    }
                  ] /* considered_access_paths */
                } /* best_access_path */,
                "condition_filtering_pct": 100,
                "rows_for_plan": 55696,
                "cost_for_plan": 22631,
                "chosen": true
              }
            ] /* considered_execution_plans */
          },
          {
            "attaching_conditions_to_tables": {
              "original_condition": "(`employees_large`.`name` > 'a')",
              "attached_conditions_computation": [
                {
                  "table": "`employees_large`",
                  "rechecking_index_usage": {
                    "recheck_reason": "low_limit",
                    "limit": 1000,
                    "row_estimate": 55696
                  } /* rechecking_index_usage */
                }
              ] /* attached_conditions_computation */,
              "attached_conditions_summary": [
                {
                  "table": "`employees_large`",
                  "attached": "(`employees_large`.`name` > 'a')"
                }
              ] /* attached_conditions_summary */
            } /* attaching_conditions_to_tables */
          },
          {
            "clause_processing": {
              "clause": "ORDER BY",
              "original_clause": "`employees_large`.`position`",
              "items": [
                {
                  "item": "`employees_large`.`position`"
                }
              ] /* items */,
              "resulting_clause_is_simple": true,
              "resulting_clause": "`employees_large`.`position`"
            } /* clause_processing */
          },
          {
            "reconsidering_access_paths_for_index_ordering": {
              "clause": "ORDER BY",
              "steps": [
              ] /* steps */,
              "index_order_summary": {
                "table": "`employees_large`",
                "index_provides_order": false,
                "order_direction": "undefined",
                "index": "unknown",
                "plan_changed": false
              } /* index_order_summary */
            } /* reconsidering_access_paths_for_index_ordering */
          },
          {
            "refine_plan": [
              {
                "table": "`employees_large`"
              }
            ] /* refine_plan */
          }
        ] /* steps */
      } /* join_optimization */
    },
    {
      "join_explain": {
        "select#": 1,
        "steps": [
        ] /* steps */
      } /* join_explain */
    }
  ] /* steps */
}
```



**ç»“è®º**

â€‹	ä»æœ€åç»“è®ºå¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ç´¢å¼•çš„ `cost` = 66836ï¼Œå…¨è¡¨æ‰«æçš„ `cost` = 22634ï¼Œæ‰€ä»¥**A**é€‰æ‹©äº†å…¨è¡¨æ‰«æã€‚

